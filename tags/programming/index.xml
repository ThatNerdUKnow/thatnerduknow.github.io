<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>programming on Brandon Piña</title><link>https://thatnerduknow.github.io/tags/programming/</link><description>Recent content in programming on Brandon Piña</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 24 Oct 2022 16:53:41 -0500</lastBuildDate><atom:link href="https://thatnerduknow.github.io/tags/programming/index.xml" rel="self" type="application/rss+xml"/><item><title>Making an Enigma Machine</title><link>https://thatnerduknow.github.io/posts/enigma-machine/</link><pubDate>Mon, 24 Oct 2022 16:53:41 -0500</pubDate><guid>https://thatnerduknow.github.io/posts/enigma-machine/</guid><description>What&amp;rsquo;s an Enigma Machine? The Enigma machine is a cipher device developed and used in the early- to mid-20th century to protect commercial, diplomatic, and military communication. It was employed extensively by Nazi Germany during World War II, in all branches of the German military. The Enigma machine was considered so secure that it was used to encipher the most top-secret messages. &amp;ndash; Wikipedia
How does it work? The Enigma machine is comprised of 3 components:</description><content>&lt;h2 id="whats-an-enigma-machine">What&amp;rsquo;s an Enigma Machine?&lt;/h2>
&lt;blockquote>
&lt;p>The Enigma machine is a cipher device developed and used in the early- to mid-20th century to protect commercial, diplomatic, and military communication. It was employed extensively by Nazi Germany during World War II, in all branches of the German military. The Enigma machine was considered so secure that it was used to encipher the most top-secret messages. &amp;ndash; Wikipedia&lt;/p>
&lt;/blockquote>
&lt;h2 id="how-does-it-work">How does it work?&lt;/h2>
&lt;p>The Enigma machine is comprised of 3 components:&lt;/p>
&lt;ul>
&lt;li>The Rotor Mechanism comprised of 3 rotors from a set of Five originally but more rotor variants were added later&lt;/li>
&lt;li>A Reflector&lt;/li>
&lt;li>A plugboard&lt;/li>
&lt;/ul>
&lt;p>Each component effectively works as a &lt;em>&lt;strong>Substitution Cipher&lt;/strong>&lt;/em> or &lt;em>&lt;strong>Caesar Cipher&lt;/strong>&lt;/em>. It&amp;rsquo;s one of the simplest ciphers there is, Simply put, each character is substituted with another character and no characters map to themselves (because that would render the cipher pointless); Think of Caesar Ciphers as those secret decoder ring toys you give to kids so that they can pretend that they&amp;rsquo;re spies.&lt;/p>
&lt;p>Now if the Enigma machine is implemented using simple Caesar Ciphers, what made it so tough to crack? The answer lies in the rotor mechanism. Every time a character is encoded through the machine, the first rotor advances in position, and in certain positions there are notches, which allow the next rotor in the sequence to advance. The machine&amp;rsquo;s configuration changes as you type! What this means in practice is that if You were to encode the same character multiple times you would get different characters every time.&lt;/p>
&lt;p>A property of the enigma machine, Enabled by use of the reflector allows messages encoded by the machine for a given configuration to also be decoded by the machine. If you know the configuration of the machine for an encoded message, you can decode the ciphertext and get the original plaintext back&lt;/p>
&lt;h2 id="lets-get-rusty">Let&amp;rsquo;s get rusty&lt;/h2>
&lt;p>Feel free to skip this part, I get very detailed here&lt;/p>
&lt;h3 id="the-cipher-newtype">The Cipher newtype&lt;/h3>
&lt;p>Since every component is implemented as a Caesar Cipher, it makes sense to start creating a type that each of our components can use internally, so that we don&amp;rsquo;t have to re-write encoding and decoding logic. The perfect underlying structure for a caesar cipher is a HashMap, or rather, a &lt;em>bidirectional&lt;/em> HashMap because the mapping relationship between characters goes both ways&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Cipher&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> HashMap&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character, Character, BuildNoHashHasher&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> HashMap&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character, Character, BuildNoHashHasher&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As you can see, I implemented the &lt;code>Cipher&lt;/code> struct as a newtype over a tuple of HashMaps; one for each side of the mapping relationship. I feel as if I should explain what&amp;rsquo;s going on in the type arguments here. The first type argument for HashMap is the type for the &lt;strong>Key&lt;/strong> and the second type argument is the type for the &lt;strong>Value&lt;/strong>. The third argument is a bit special. Internally HashMaps in rust use a cryptographically secure hashing function to generate hashes for its keys. The reason for this is to prevent DOS attacks against the hash. This is fine and all, but it&amp;rsquo;s rather slow for our purposes. Fortunately for us, HashMap allows us to replace the Hashing Function that it uses internally. Since the data we&amp;rsquo;re storing in this hashmap isn&amp;rsquo;t terribly important and the data inside the &lt;code>Character&lt;/code> newtype (more on that later) is a simple char we can use the &lt;code>NoHash&lt;/code> hashing function. NoHash does exactly what it sounds like, Nothing. If my understanding is correct, it uses the bitwise representation of the value itself as its key. Since it&amp;rsquo;s not doing very much work under the hood, this makes the hashing function much, much faster. While this is much faster than using the original hashing function, It was only marginally (2%) faster than the original implementation which used a Vector Internally. I would say the reason for this is likely because &lt;em>n&lt;/em> is small and the relatively expensive operation of decoding is the only place where we would have seen a speed-up and that only happens three times per Character in the entire machine.&lt;/p>
&lt;p>The Cipher type includes a bit of validation inside the constructor&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">impl&lt;/span> FromStr &lt;span style="color:#66d9ef">for&lt;/span> Cipher {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">type&lt;/span> Err &lt;span style="color:#f92672">=&lt;/span> Bruh;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">from_str&lt;/span>(s: &lt;span style="color:#66d9ef">&amp;amp;&lt;/span>&lt;span style="color:#66d9ef">str&lt;/span>) -&amp;gt; Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Self, Self::Err&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Convert each char in the string slice into the Character newtype
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Ensuring that the only characters inside the provided string are
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// A-Z
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">let&lt;/span> res: Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .chars()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .into_iter()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .map(&lt;span style="color:#f92672">|&lt;/span>c&lt;span style="color:#f92672">|&lt;/span> Character::try_from(c))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .try_collect()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .with_context(&lt;span style="color:#f92672">||&lt;/span> format!(&lt;span style="color:#e6db74">&amp;#34;Tried to create a cipher from a string&amp;#34;&lt;/span>))&lt;span style="color:#f92672">?&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Check the length of the provided string, we need exactly 26 characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">match&lt;/span> s.len() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">..=&lt;/span>&lt;span style="color:#ae81ff">25&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Err(bruh&lt;span style="color:#f92672">!&lt;/span>(CipherError::TooFew(s.len()))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">26&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Cipher::try_from(res), &lt;span style="color:#75715e">// Try to construct Cipher from Vec of Characters
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> _ &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Err(bruh&lt;span style="color:#f92672">!&lt;/span>(CipherError::TooMany(s.len()))),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">impl&lt;/span> TryFrom&lt;span style="color:#f92672">&amp;lt;&lt;/span>Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> Cipher {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Error&lt;/span> &lt;span style="color:#f92672">=&lt;/span> Bruh;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">try_from&lt;/span>(value: Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Character&lt;span style="color:#f92672">&amp;gt;&lt;/span>) -&amp;gt; Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Self, Self::Error&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Remove duplicates from provided Vector
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">let&lt;/span> res &lt;span style="color:#f92672">=&lt;/span> value.iter().unique().count();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> res {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// If we get 26 unique Characters, we can start building our Cipher
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// We iterate through chars A-Z then convert them into Character newtypes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// We use the current value of the iterator to generate our mapping
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> (&lt;span style="color:#e6db74">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#f92672">..=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;Z&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .into_iter()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .map(&lt;span style="color:#f92672">|&lt;/span>c&lt;span style="color:#f92672">|&lt;/span> Character::try_from(c).unwrap())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .enumerate()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .fold(Ok(Cipher::new()), &lt;span style="color:#f92672">|&lt;/span>acc, (i, next)&lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">match&lt;/span> acc {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Ok(&lt;span style="color:#66d9ef">mut&lt;/span> cipher) &lt;span style="color:#f92672">=&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cipher.&lt;span style="color:#ae81ff">0.&lt;/span>insert(next, value[i]); &lt;span style="color:#75715e">// Map next-&amp;gt;value[i]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> cipher.&lt;span style="color:#ae81ff">1.&lt;/span>insert(value[i], next); &lt;span style="color:#75715e">// Map value[i]-&amp;gt;next
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Ok(cipher) &lt;span style="color:#75715e">// Return the valid cipher
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Err(_) &lt;span style="color:#f92672">=&amp;gt;&lt;/span> unreachable!(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _ &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Err(bruh&lt;span style="color:#f92672">!&lt;/span>(CipherError::Unique)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As you can see the validation rules implemented for Cipher are&lt;/p>
&lt;ul>
&lt;li>Any string passed must be exactly 26 characters long&lt;/li>
&lt;li>Each string must contain exactly 26 unique characters&lt;/li>
&lt;li>Each string must only contain characters A-Z&lt;/li>
&lt;/ul>
&lt;h3 id="the-character-and-position-newtypes">The Character and Position newtypes&lt;/h3>
&lt;h4 id="whats-a-newtype">What&amp;rsquo;s a newtype?&lt;/h4>
&lt;p>&lt;strong>In Gundam:&lt;/strong> &lt;em>A newtype is an evolved species of humans that have adapted to life in space&lt;/em>&lt;br>
&lt;strong>In Programming:&lt;/strong> &lt;em>A newtype is a type declared from the definition of an existing type&lt;/em>&lt;/p>
&lt;p>In the context of programming, what does this really mean?&lt;/p>
&lt;p>Our language gives us primitive types that we can use to compose data structures. These primitives typically include booleans (true and false), numerical types (integers, floats), string slices and probably a few i&amp;rsquo;m forgetting. Let&amp;rsquo;s say that I want to represent a distance as a floating point decimal. Let&amp;rsquo;s say kilometers and meters. I might go about it in this way:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> kilometers: &lt;span style="color:#66d9ef">f64&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">10&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> meters: &lt;span style="color:#66d9ef">f64&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Can you see the problem? &lt;code>kilometers&lt;/code> and &lt;code>meters&lt;/code> are both the same type! That means that adding them together is perfectly valid! Also since they&amp;rsquo;re both &lt;code>f64&lt;/code>&amp;rsquo;s they can both be initialized as negative. We don&amp;rsquo;t want negative distances, that&amp;rsquo;s impossible! In the newtype pattern what we would do instead is wrap each of our scalars in a &lt;em>named tuple&lt;/em> Then impose validation rules inside functions that construct this type.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Kilometers&lt;/span>(&lt;span style="color:#66d9ef">f64&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Meters&lt;/span>(&lt;span style="color:#66d9ef">f64&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Use your imagination for the constructors
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// This tangent is long enough
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We could also implement the arithmetic operators between these types, allowing us to add, subtract, divide and multiply variables of these types and get results that we expect! Keep in mind that the newtype pattern is much more than simple &lt;em>type aliasing&lt;/em> It&amp;rsquo;s essentially a named tuple!&lt;/p>
&lt;h4 id="rant-over">Rant over&lt;/h4>
&lt;p>In libenigma I defined three newtypes; one of which i&amp;rsquo;ve already explained. The remaining newtypes are Character and Position.
Character is used throughout the project while Position is used exclusively inside the Rotor Struct&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#[derive(Debug, PartialEq, Eq, Hash, Clone, Copy)]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Character&lt;/span>(&lt;span style="color:#66d9ef">char&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Implementing this trait allows us to use it as a key in NoHash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">impl&lt;/span> IsEnabled &lt;span style="color:#66d9ef">for&lt;/span> Character {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#[derive(PartialEq, Eq, Clone, Copy, Debug, Hash, PartialOrd)]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Position&lt;/span>(&lt;span style="color:#66d9ef">u8&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The constructor for Character ensures that the internal char is only characters between &amp;lsquo;A&amp;rsquo; and &amp;lsquo;Z&amp;rsquo;. It does this using a match statement. If the character matches to the range match arm &amp;lsquo;A&amp;rsquo;..=&amp;lsquo;Z&amp;rsquo; it is allowed through, otherwise it returns an error type with the original char wrapped inside (this is important so that we don&amp;rsquo;t lose symbols, or non alphabetic characters). The constructor for Position is virtually identical, so i&amp;rsquo;ll omit it&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">impl&lt;/span> TryFrom&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">char&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> Character {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Error&lt;/span> &lt;span style="color:#f92672">=&lt;/span> ParsingError;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">try_from&lt;/span>(value: &lt;span style="color:#66d9ef">char&lt;/span>) -&amp;gt; Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Self, Self::Error&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> value_uppercase &lt;span style="color:#f92672">=&lt;/span> value.to_ascii_uppercase(); &lt;span style="color:#75715e">// Convert the char to uppercase
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">match&lt;/span> value_uppercase {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#f92672">..=&lt;/span>&lt;span style="color:#e6db74">&amp;#39;Z&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Ok(Character(value_uppercase)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _ &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Err(ParsingError::Charset(value)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="the-rotor-struct">The Rotor Struct&lt;/h3>
&lt;p>The rotor struct contains the following fields&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Rotor&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> position: &lt;span style="color:#a6e22e">Position&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cipher: &lt;span style="color:#a6e22e">Cipher&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> notches: &lt;span style="color:#a6e22e">Notches&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// I lied, there&amp;#39;s more than three newtypes, but this one isn&amp;#39;t public
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// I should rather say that there&amp;#39;s three publicly exposed newtypes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">#[derive(Hash, Debug)]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Notches&lt;/span>(Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Position&lt;span style="color:#f92672">&amp;gt;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Each Cipher contains two functions, &lt;em>encode&lt;/em> and &lt;em>decode&lt;/em>. We use these methods to share the encoding logic between each component of the enigma machine.
The logic in these functions is deceptively simple, what you don&amp;rsquo;t see is a whole mess of well-tested overloaded operators&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">encode_at&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, c: &lt;span style="color:#a6e22e">Character&lt;/span>, n: &lt;span style="color:#66d9ef">usize&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">Character&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> offset: &lt;span style="color:#a6e22e">Position&lt;/span> &lt;span style="color:#f92672">=&lt;/span> self.position &lt;span style="color:#f92672">+&lt;/span> n;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self.cipher.encode(c &lt;span style="color:#f92672">+&lt;/span> offset)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">decode_at&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, c: &lt;span style="color:#a6e22e">Character&lt;/span>, n: &lt;span style="color:#66d9ef">usize&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">Character&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> offset: &lt;span style="color:#a6e22e">Position&lt;/span> &lt;span style="color:#f92672">=&lt;/span> self.position &lt;span style="color:#f92672">+&lt;/span> n;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> dec &lt;span style="color:#f92672">=&lt;/span> self.cipher.decode(c);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dec &lt;span style="color:#f92672">-&lt;/span> offset
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>There&amp;rsquo;s actually a lot to unpack here. These functions gave me a lot of trouble when it came around to integration testing because for the life of me I coulnd&amp;rsquo;t figure out why i could encode a character through a rotor, then decode the ciphertext back through the rotor and i&amp;rsquo;d get a different character from what I started out with. THe problem was &lt;em>where&lt;/em> I was doing the addidion of the rotor&amp;rsquo;s offset to the encoding. In encode_at I was adding the offset to the character before encoding the character while originally I was doing the same in decode_at. However, it took some thinking through and talking to a rubber duck to reason around why this was causing me problems. Unfortunately I lack the language skills to explain why&lt;/p>
&lt;p>Also the reason these functions are called encode_at instead of simply encode is that here we&amp;rsquo;re encoding the character given a certain number of rotations of the current rotor. This is absolutely critical for multithreading later as we don&amp;rsquo;t have to rely on internal state, meaning that we can encode characters &lt;em>out of order&lt;/em> but we have to be able to predict how many times the current rotor has advanced. That&amp;rsquo;s where this function comes in:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">/// given n revolutions of the current rotor, how many times will the next rotor in the sequence advance?
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&lt;/span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">get_num_advances&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, n: &lt;span style="color:#66d9ef">usize&lt;/span>) -&amp;gt; &lt;span style="color:#66d9ef">usize&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> r &lt;span style="color:#f92672">=&lt;/span> n &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span>; &lt;span style="color:#75715e">// Number of full revolutions
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">let&lt;/span> notches_left &lt;span style="color:#f92672">=&lt;/span> self
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .notches
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .iter()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .filter(&lt;span style="color:#f92672">|&lt;/span>notch&lt;span style="color:#f92672">|&lt;/span> self.position &lt;span style="color:#f92672">&amp;lt;=&lt;/span> &lt;span style="color:#f92672">**&lt;/span>notch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .count(); &lt;span style="color:#75715e">// How many notches are left in the first rotation of the rotor, given the inital position of the rotor
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> final_position &lt;span style="color:#f92672">=&lt;/span> Position::try_from((n &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">26&lt;/span>) &lt;span style="color:#66d9ef">as&lt;/span> &lt;span style="color:#66d9ef">u8&lt;/span>).unwrap(); &lt;span style="color:#75715e">// gets the position of the rotor after n advances
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">let&lt;/span> notches_past &lt;span style="color:#f92672">=&lt;/span> self
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .notches
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .iter()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .filter(&lt;span style="color:#f92672">|&lt;/span>notch&lt;span style="color:#f92672">|&lt;/span> final_position &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">**&lt;/span>notch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .count(); &lt;span style="color:#75715e">// How many notches have we passed in the current partial revolution
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Multiply full rotations by the number of notches and add the number of notches left in the first rotation
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#66d9ef">mut&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> (r &lt;span style="color:#f92672">*&lt;/span> self.notches.&lt;span style="color:#ae81ff">0.&lt;/span>len()) &lt;span style="color:#f92672">+&lt;/span> notches_left;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// If we&amp;#39;ve completed at least one rotation, add notches_past
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> r &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result &lt;span style="color:#f92672">=&lt;/span> result &lt;span style="color:#f92672">+&lt;/span> notches_past
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This function says &amp;ldquo;Given how many times this rotor has advanced, how many times will it advance the next rotor?&amp;rdquo;. We can use this information to pass to the next rotor in the sequence to get the position of every rotor given &lt;em>n&lt;/em> characters encoded.&lt;/p>
&lt;p>Also, I don&amp;rsquo;t allow construction of Rotors directly, I generate them based off of the reference table from wikipedia, Meaning that assuming that my unit tests are correct and wikipedia&amp;rsquo;s information is correct, you could decipher real world enigma transmissions using this library. Neat!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#[derive(
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> EnumString, EnumIter, Hash, PartialEq, Eq, Clone, Copy, Display, Debug, Serialize, Deserialize,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">Rotors&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> I,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> II,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> III,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> IV,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> V,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VI,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VII,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VIII,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">impl&lt;/span> TryFrom&lt;span style="color:#f92672">&amp;lt;&lt;/span>(Rotors, &lt;span style="color:#66d9ef">char&lt;/span>)&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">for&lt;/span> Rotor {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Error&lt;/span> &lt;span style="color:#f92672">=&lt;/span> Bruh;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">try_from&lt;/span>((variant, position): (Rotors, &lt;span style="color:#66d9ef">char&lt;/span>)) -&amp;gt; Result&lt;span style="color:#f92672">&amp;lt;&lt;/span>Self, Self::Error&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> variant {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::I &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;EKMFLGDQVZNTOWYHXUSPAIBRCJ&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;Q&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::II &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;AJDKSIRUXBLHWTMCQGZNPYFVOE&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;E&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::III &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;BDFHJLCPRTXVZNYEIWGAKMUSQO&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;V&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::IV &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;ESOVPZJAYQUIRHXLNFTGKDCMWB&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;J&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::V &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;VZBRGITYUPSDNHLXAWMJQOFECK&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;Z&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::VI &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;JPGVOUMFYQBENHZRDKASXLICTW&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;Z&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;M&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::VII &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;NZJHGRCXMYSWBOUFAIVLPEKQDT&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;Z&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;M&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rotors::VIII &lt;span style="color:#f92672">=&amp;gt;&lt;/span> Rotor::new(&lt;span style="color:#e6db74">&amp;#34;FKQHTLXOCBJSPDZRAMEWNIUYGV&amp;#34;&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>[&lt;span style="color:#e6db74">&amp;#39;Z&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;M&amp;#39;&lt;/span>], position),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="the-reflector">The Reflector&lt;/h3>
&lt;p>This component was the simplest because It requires little configuration on the part of the user, Simply pick a reflector variant and you&amp;rsquo;re good to go.
The construction of the reflector is virtually identical to Rotor, so i&amp;rsquo;ll omit it but keep in mind that we don&amp;rsquo;t have to keep track of the position of the reflector because it&amp;rsquo;s not a moving part. Otherwise The reflector works exactly the same. However, the reflector has a special property that it only accepts connections on one side. Meaning that insead of being able to encode then decode a character to get your original character back, you are able to encode, the &lt;em>encode again&lt;/em> to get your original character back. This is the reason why you can decode enigma messages given the same configuration.&lt;/p>
&lt;p>Also the encode function is very nice to look at&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">impl&lt;/span> Encode &lt;span style="color:#66d9ef">for&lt;/span> Reflector {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">/// Encodes a given char through the reflector.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&lt;/span> &lt;span style="color:#e6db74">/// Given the properties of the reflector, if the output of this function was fed through this function again,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&lt;/span> &lt;span style="color:#e6db74">/// you would get back the original char
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&lt;/span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">encode&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, c: &lt;span style="color:#a6e22e">Character&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">Character&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self.cipher.encode(c)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="the-plugboard">The plugboard&lt;/h3>
&lt;p>In the enigma machine you are given ten plugs, You are given the choice to map any character to any other character. You may not map multiple characters to the same character(because you physically could not on the original machine) and you can use no more than 10 plugs(because the machine only came with 10) you also don&amp;rsquo;t have to use all of the plugs. Or any for that matter. Given the complexity of this component (and the fact i had to write an interface to generate one from the command line) I&amp;rsquo;ll try to keep this short&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Plugboard&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cipher: &lt;span style="color:#a6e22e">Cipher&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Internally the Plugboard contains only a cipher. Most of the logic in this module is geared towards &lt;em>constructing&lt;/em> a valid cipher string given user input
Basically we take a vec of tuples &lt;code>(Character,Character)&lt;/code> and validate them against the aforementioned invariants then create our cipher string and use it as our internal cipher. Likewise, the encode function is very simple here. We simply pass the given Character to the internal Cipher newtype. Oh also I should mention that like the Reflector, The mappings in the plugboard go both ways.&lt;/p>
&lt;h3 id="putting-it-together-enigma">Putting it together: Enigma&lt;/h3>
&lt;p>As I said before, each component in the engima machine acts as a substitution cipher. However, the order in which you apply these ciphers is important&lt;/p>
&lt;ul>
&lt;li>A Key is pressed&lt;/li>
&lt;li>That character is encoded through the plugboard&lt;/li>
&lt;li>The ciphertext from the plugboard is then encoded through each individual rotor&lt;/li>
&lt;li>The output from the rotor mechanism is encoded through the reflector&lt;/li>
&lt;li>The output from the reflector is fed &lt;em>backwards&lt;/em> through the rotor mechanism&lt;/li>
&lt;li>The ciphertext makes one final pass through the plugboard&lt;/li>
&lt;li>Then we get the final character&lt;/li>
&lt;/ul>
&lt;p>Here&amp;rsquo;s what the code looks like for a single character:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">encode_at&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, c: &lt;span style="color:#a6e22e">Character&lt;/span>, n: &lt;span style="color:#66d9ef">usize&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">Character&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> plugboard_enc &lt;span style="color:#f92672">=&lt;/span> self.plugboard.encode(c);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> rotor_enc &lt;span style="color:#f92672">=&lt;/span> self.rotors.encode_at(plugboard_enc, n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> reflector_enc &lt;span style="color:#f92672">=&lt;/span> self.reflector.encode(rotor_enc);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> rotor_dec &lt;span style="color:#f92672">=&lt;/span> self.rotors.decode_at(reflector_enc, n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> plugboard_dec &lt;span style="color:#f92672">=&lt;/span> self.plugboard.decode(rotor_dec);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> plugboard_dec
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Oh my, I lied again! I actually declared &lt;em>four&lt;/em> public newtypes. Essentially here I abstract away feeding the output of each rotor into the next into a single operation&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">RotorConfig&lt;/span>(Vec&lt;span style="color:#f92672">&amp;lt;&lt;/span>Rotor&lt;span style="color:#f92672">&amp;gt;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">impl&lt;/span> RotorConfig {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">encode_at&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, c: &lt;span style="color:#a6e22e">Character&lt;/span>, n: &lt;span style="color:#66d9ef">usize&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">Character&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> encode_first_rotor &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>].encode_at(c, n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> n &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>].get_num_advances(n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> encode_second_rotor &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">1&lt;/span>].encode_at(encode_first_rotor, n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> n &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">1&lt;/span>].get_num_advances(n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> encode_third_rotor &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">2&lt;/span>].encode_at(encode_second_rotor, n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> encode_third_rotor
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">decode_at&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, c: &lt;span style="color:#a6e22e">Character&lt;/span>, n: &lt;span style="color:#66d9ef">usize&lt;/span>) -&amp;gt; &lt;span style="color:#a6e22e">Character&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> r1_advances &lt;span style="color:#f92672">=&lt;/span> n;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> r2_advances &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>].get_num_advances(n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> r3_advances &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">1&lt;/span>].get_num_advances(r2_advances);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> decode_third_rotor &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">2&lt;/span>].decode_at(c, r3_advances);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> decode_second_rotor &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">1&lt;/span>].decode_at(decode_third_rotor, r2_advances);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> decode_first_rotor &lt;span style="color:#f92672">=&lt;/span> self.&lt;span style="color:#ae81ff">0&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>].decode_at(decode_second_rotor, r1_advances);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> decode_first_rotor
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s not terribly useful to only be able to encode one character at a time, So I needed to write a function that could encode an entire String&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">pub&lt;/span> &lt;span style="color:#66d9ef">fn&lt;/span> &lt;span style="color:#a6e22e">encode&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>self, s: &lt;span style="color:#66d9ef">&amp;amp;&lt;/span>String) -&amp;gt; String {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> s.par_char_indices()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .map(&lt;span style="color:#f92672">|&lt;/span>(i, c)&lt;span style="color:#f92672">|&lt;/span> (i, Character::try_from(c)))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .map(&lt;span style="color:#f92672">|&lt;/span>(n, c)&lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#66d9ef">match&lt;/span> c {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Ok(plain) &lt;span style="color:#f92672">=&amp;gt;&lt;/span> self.encode_at(plain, n).into(), &lt;span style="color:#75715e">// If character is &amp;#39;A&amp;#39;-&amp;#39;Z&amp;#39;, encode it
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Err(e) &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">match&lt;/span> e {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ParsingError::Charset(non_alphabetic) &lt;span style="color:#f92672">=&amp;gt;&lt;/span> non_alphabetic, &lt;span style="color:#75715e">// Otherwise, simply return the original character
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> _ &lt;span style="color:#f92672">=&amp;gt;&lt;/span> unreachable!(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .collect()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>There&amp;rsquo;s actually something special going on here. Can you see it? I&amp;rsquo;m multithreading it! Using the excellent &lt;code>rayon&lt;/code> crate, I&amp;rsquo;m able to generate a &lt;em>parallel&lt;/em> iterator from this string, allowing me to build my logic in the same manner as if I was writing a single threaded version!!!&lt;/p>
&lt;h2 id="the-benchmarks">The Benchmarks:&lt;/h2>
&lt;p>The benchmark generates a string of random characters (All A-Z) given length &lt;em>n&lt;/em>&lt;br>
I&amp;rsquo;ve generated benchmarks for strings of the following lengths&lt;/p>
&lt;ul>
&lt;li>1 thousand&lt;/li>
&lt;li>10 thousand&lt;/li>
&lt;li>100 thousand&lt;/li>
&lt;li>1 million&lt;/li>
&lt;li>10 million&lt;/li>
&lt;li>100 million&lt;/li>
&lt;/ul>
&lt;p>Here&amp;rsquo;s the results&lt;/p>
&lt;pre tabindex="0">&lt;code> Running benches\perf.rs (target\release\deps\perf-f5e366b5f8262b43.exe)
1k time: [215.39 µs 216.71 µs 218.12 µs]
Found 5 outliers among 100 measurements (5.00%)
5 (5.00%) high mild
10k time: [591.08 µs 594.62 µs 598.26 µs]
Found 4 outliers among 100 measurements (4.00%)
1 (1.00%) low mild
3 (3.00%) high mild
Benchmarking 100k: Warming up for 3.0000 s
Warning: Unable to complete 100 samples in 5.0s. You may wish to increase target time to 9.6s, enable flat sampling, or reduce sample count to 50.
100k time: [1.8469 ms 1.8593 ms 1.8730 ms]
Found 3 outliers among 100 measurements (3.00%)
3 (3.00%) high mild
1m time: [9.3270 ms 9.4011 ms 9.4863 ms]
Found 1 outliers among 100 measurements (1.00%)
1 (1.00%) high severe
Benchmarking 10m: Warming up for 3.0000 s
Warning: Unable to complete 100 samples in 5.0s. You may wish to increase target time to 7.9s, or reduce sample count to 60.
10m time: [79.100 ms 79.525 ms 79.963 ms]
Found 4 outliers among 100 measurements (4.00%)
4 (4.00%) high mild
Benchmarking 100m: Warming up for 3.0000 s
Warning: Unable to complete 100 samples in 5.0s. You may wish to increase target time to 78.5s, or reduce sample count to 10.
100m time: [768.39 ms 771.83 ms 775.81 ms]
Found 5 outliers among 100 measurements (5.00%)
2 (2.00%) high mild
3 (3.00%) high severe
&lt;/code>&lt;/pre>&lt;p>That&amp;rsquo;s right, We can encode 100 Million characters in less than a second, Or more practically, 1 million characters in around 9 Milliseconds. To put that in perspective, Herman Melville&amp;rsquo;s &lt;em>Moby Dick&lt;/em> utf-8 version from project gutenburg is a little over a megabyte. If we assume that each character takes up between 1 and 4 bytes per character (and let&amp;rsquo;s face it it&amp;rsquo;s mostly ascii) that gives us approximately a little over a million characters. We could encode the entirety of &lt;strong>Moby Dick&lt;/strong> In &lt;em>&lt;strong>Thousandths&lt;/strong>&lt;/em> of a second. How about Crime and Punishment? War and peace?&lt;/p>
&lt;ul>
&lt;li>Crime and Punishment: 1.1MB&lt;/li>
&lt;li>War and Peace: 3.2 MB&lt;br>
Not even Russian Literature stands a chance!&lt;/li>
&lt;/ul></content></item><item><title>Typescript Is Magic</title><link>https://thatnerduknow.github.io/posts/typescript-is-magic/</link><pubDate>Wed, 31 Aug 2022 17:26:00 -0500</pubDate><guid>https://thatnerduknow.github.io/posts/typescript-is-magic/</guid><description>Typescript somehow always manages to find new and exciting ways to surprise me. It&amp;rsquo;s no secret that investing time in defining good types for your projects is well worth it as you get better intellisense and lower cognitive load when dealing with your custom types. (What properties exist on this object again?) However, sometimes it can be difficult to define a type for an upstream service, like an API. If you know what keys/types to expect beforehand you might define your types as such:</description><content>&lt;p>Typescript somehow always manages to find new and exciting ways to surprise me. It&amp;rsquo;s no secret that investing time in defining good types for your projects is well worth it as you get better intellisense and lower cognitive load when dealing with your custom types. (&lt;em>What properties exist on this object again?&lt;/em>) However, sometimes it can be difficult to define a type for an upstream service, like an API. If you know what keys/types to expect beforehand you might define your types as such:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">APIResponse&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">data&lt;/span>: &lt;span style="color:#66d9ef">APIData&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#a6e22e">APIError&lt;/span>; &lt;span style="color:#75715e">// Data returned by the api could be valid or not
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">headers&lt;/span>: &lt;span style="color:#66d9ef">Record&lt;/span>&amp;lt;&lt;span style="color:#f92672">string&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">,&lt;/span> &lt;span style="color:#a6e22e">string&lt;/span>&amp;gt;;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">timestamp&lt;/span>: &lt;span style="color:#66d9ef">Date&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">motd&lt;/span>: &lt;span style="color:#66d9ef">string&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Therefore we need to know what properties to expect
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">APIData&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">foo&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;bar&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">APIError&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">message&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;You done goofed&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="the-problem">The problem&lt;/h2>
&lt;p>But what if you don&amp;rsquo;t know what keys exist at build time? Like in the case an api batch endpoint or a configuration file? What if certain key patterns map to certain types? Enter &lt;em>&lt;strong>Template Literals&lt;/strong>&lt;/em> and &lt;em>&lt;strong>Intersection types&lt;/strong>&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Define individual record types with a key matching a pattern
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// defined by a template literal and the corresponding type
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">stringRecord&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Record&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#e6db74">`String&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>&lt;span style="color:#66d9ef">number&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">`&lt;/span>,&lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#75715e">// Properties with keys matching &amp;#34;String${number}&amp;#34; will be of type string
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">numberRecord&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Record&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#e6db74">`Number&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>&lt;span style="color:#66d9ef">number&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">`&lt;/span>,&lt;span style="color:#66d9ef">number&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#75715e">// Properties with keys matching &amp;#34;Number${number}&amp;#34; will be of type number
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// An intersection type rather than a union type is necessary
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Because the record types need to coexist
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// rather than being of one type or the other
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">intersectionRecord&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">stringRecord&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#a6e22e">numberRecord&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span>: &lt;span style="color:#66d9ef">intersectionRecord&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`String&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">`&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Bar&amp;#34;&lt;/span> &lt;span style="color:#75715e">// Valid
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`Number&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">`&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#75715e">// Also Valid
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here&amp;rsquo;s where things get interesting. &lt;em>Typescript can warn us of invalid uses of our type&lt;/em> on both our keys and values of the record.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Invalid assignment to valid key
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`Number&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">`&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Baz&amp;#34;&lt;/span> &lt;span style="color:#75715e">// Type &amp;#39;string&amp;#39; is not assignable to type &amp;#39;number&amp;#39;.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`String&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">`&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#75715e">// Type &amp;#39;number&amp;#39; is not assignable to type &amp;#39;string&amp;#39;.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Assignment to invalid key
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`NumberA`&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#75715e">// Property &amp;#39;NumberA&amp;#39; does not exist on type &amp;#39;intersectionRecord&amp;#39;.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`StringA`&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Foo&amp;#34;&lt;/span> &lt;span style="color:#75715e">// Property &amp;#39;StringA&amp;#39; does not exist on type &amp;#39;intersectionRecord&amp;#39;.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">foo&lt;/span>[&lt;span style="color:#e6db74">`Invalid Key`&lt;/span>] &lt;span style="color:#75715e">// Property &amp;#39;Invalid Key&amp;#39; does not exist on type &amp;#39;intersectionRecord&amp;#39;.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="okay-so-what">Okay, so what?&lt;/h2>
&lt;p>Imagine if you will our api provides us a batch endpoint which we may make multiple requests and make subsequent requests based on other requests in the batch. We may request different &lt;em>&lt;strong>types&lt;/strong>&lt;/em> of resources and a single union type record: &lt;code>Record&amp;lt;string, ResourceA|ResourceB|etc.&amp;gt;&lt;/code> type may not be suitable for our needs. If we can derive the type we expect from the &lt;em>&lt;strong>key&lt;/strong>&lt;/em> of the object instead of using a union type record, we can provide an extra level of type safety!&lt;/p>
&lt;h2 id="tldr">TLDR&lt;/h2>
&lt;p>Using &lt;em>Intersection Types&lt;/em> and &lt;em>Template Literals&lt;/em> in a record type allows us to derive an object&amp;rsquo;s type based off of it&amp;rsquo;s key. This is especially useful when you don&amp;rsquo;t know how many keys may exist on this object at build time with the caveat that the keys must follow a predictable pattern&lt;/p></content></item><item><title>I'm probably on a watchlist now</title><link>https://thatnerduknow.github.io/posts/financial-disclosures/</link><pubDate>Sat, 27 Aug 2022 22:23:33 -0500</pubDate><guid>https://thatnerduknow.github.io/posts/financial-disclosures/</guid><description>At the beginning of this year I was itching to start a new project, and found one that sparked my interest. At the time I noticed online that there was interest around tracking the finances of politicians in the U.S. Senate and House of Representatives. The reason being that representatives and senators are privy to and influence economic policy which can and often do impact the stock market. This presents a conflict of interest on their part as at this point they can still participate in the stock market and may pass policies that impact their portfolio favorably.</description><content>&lt;p>At the beginning of this year I was itching to start a new project, and found one that sparked my interest. At the time I noticed online that there was interest around tracking the finances of politicians in the U.S. Senate and House of Representatives. The reason being that representatives and senators are privy to and influence economic policy which can and often do impact the stock market. This presents a conflict of interest on their part as at this point they can still participate in the stock market and may pass policies that impact their portfolio favorably. As a result, &lt;a href="https://prospect.org/power/congress-beats-wall-street-at-its-own-game/">concern of insider trading in congress has been growing in recent years&lt;/a>. Tracking politicians&amp;rsquo; finances isn&amp;rsquo;t a new idea, (see the Nancy Pelosi ETF). It seems however, that previous trackers have been focused on specific members. This is why I presume &lt;strong>@PelosiTracker&lt;/strong> was banned from twitter. I decided to track all congress&amp;rsquo; financial disclosures. But where would I get the data?&lt;/p>
&lt;blockquote>
&lt;p>On April 4, 2012, President Obama signed into law the Stop Trading on Congressional Knowledge Act of 2012, Pub. L. No. 112-105 (2012) (STOCK Act). Section 6 of the STOCK Act adds new subsection 103(l) to the Ethics in Government Act of 1978, 5 U.S.C. app. 4, § 101 et seq. (EIGA). Effective July 3, 2012, subsection 103(l) of EIGA requires that not later than 30 days after receiving notification of any transaction required to be reported under subsection 102(a)(5)(B) of EIGA, but in no case later than 45 days after such a transaction, a covered employee must file a report of the transaction.&lt;/p>
&lt;/blockquote>
&lt;h2 id="thanks-obama">&lt;em>Thanks, Obama&lt;/em>&lt;/h2>
&lt;p>The idea of the STOCK act and EIGA is to keep Congress honest. That&amp;rsquo;s the idea at least. Financial disclosure data is available from the &lt;a href="https://disclosures-clerk.house.gov/PublicDisclosure/FinancialDisclosure">House Clerk&lt;/a> and the &lt;a href="https://efdsearch.senate.gov/search/home/">Senate Clerk&lt;/a> websites. The problem remains on how to get the data from these sites. I used a library called puppeteer to control a headless chromium web browser to scrape the documents from the house disclosure site. This gave me metadata such as Name, Date and Report type as well as a url where I could download a PDF of the submitted report. Now that I have the PDF File, How am I going to post it to twitter? As of now, there is no way to post a PDF as an attachment to a tweet. I need to convert it to JPEG files&lt;/p>
&lt;h2 id="this-is-where-the-magick-happens">This is where the Magick happens&lt;/h2>
&lt;p>There is a FOSS tool out there called ImageMagick that can convert images between formats and even do some processing as well. The conversion feature suits my needs perfectly fine. Importantly, we can control it using a library. I found a library with bindings for node unsurprisingly called &lt;em>imagemagick&lt;/em> and I started merrily converting away. To tell the truth there&amp;rsquo;s not much to say here, despite the fact that without this specific component, this project would have never shipped.&lt;/p>
&lt;h2 id="posting-to-twitter">Posting to Twitter&lt;/h2>
&lt;p>To get an API key for Twitter, you need to submit an application and furthermore to get write access (which I need to post tweets) I need to submit yet another application. I managed to get write access easily enough, but at first my write access application was denied for reasons unknown. I appealed the decision and managed to get the access I needed to start tweeting.&lt;/p>
&lt;h2 id="deployment">Deployment&lt;/h2>
&lt;p>In a monster fueled fever dream, I managed to get a proof of concept up and running in the space of 24 hours, but there was still the matter of deploying the bot. I was having issues docker-izing the bot as it required dependencies outside the npm ecosystem&lt;/p>
&lt;p>Here&amp;rsquo;s the dockerfile I ended up with&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">FROM&lt;/span>&lt;span style="color:#e6db74"> node:16-bullseye-slim&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">WORKDIR&lt;/span>&lt;span style="color:#e6db74"> /usr/src/app&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">COPY&lt;/span> . .&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Set imagemagick&amp;#39;s cache directory to our mount point so that we don&amp;#39;t bloat our docker storage&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">ENV&lt;/span> MAGICK_TMPDIR /usr/src/app/config/cache&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Do stuff that puppeteer requires for some reason&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> apt-get update &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> apt-get install -y wget gnupg &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> sh -c &lt;span style="color:#e6db74">&amp;#39;echo &amp;#34;deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main&amp;#34; &amp;gt;&amp;gt; /etc/apt/sources.list.d/google.list&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> apt-get update &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> apt-get install -y google-chrome-stable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --no-install-recommends &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> rm -rf /var/lib/apt/lists/*&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Insall other deps&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> apt-get update &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> apt-get install -y imagemagick ghostscript&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Edit ImageMagick PDF Policy for read/write access&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> sed -i_bak &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>&lt;span style="color:#e6db74">&amp;#39;s/rights=&amp;#34;none&amp;#34; pattern=&amp;#34;PDF&amp;#34;/rights=&amp;#34;read | write&amp;#34; pattern=&amp;#34;PDF&amp;#34;/&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>/etc/ImageMagick-6/policy.xml&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Edit ImageMagick policy for a bigger disk cache&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> sed -i &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>&lt;span style="color:#e6db74">&amp;#39;s/domain=&amp;#34;resource&amp;#34; name=&amp;#34;disk&amp;#34; value=&amp;#34;1GiB&amp;#34;/ domain=&amp;#34;resource&amp;#34; name=&amp;#34;disk&amp;#34; value=&amp;#34;10GiB&amp;#34;/&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>/etc/ImageMagick-6/policy.xml&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Limit each instance&amp;#39;s thread count to 1&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> sed -i &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>&lt;span style="color:#e6db74">&amp;#39;s/domain=&amp;#34;resource&amp;#34; name=&amp;#34;thread&amp;#34; value=&amp;#34;2&amp;#34;/ domain=&amp;#34;resource&amp;#34; name=&amp;#34;thread&amp;#34; value=&amp;#34;1&amp;#34;/&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>/etc/ImageMagick-6/policy.xml&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Give imagemagick more memory&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> sed -i &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>&lt;span style="color:#e6db74">&amp;#39;s/domain=&amp;#34;resource&amp;#34; name=&amp;#34;memory&amp;#34; value=&amp;#34;256MiB&amp;#34;/ domain=&amp;#34;resource&amp;#34; name=&amp;#34;memory&amp;#34; value=&amp;#34;2GiB&amp;#34;/&amp;#39;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>/etc/ImageMagick-6/policy.xml&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Install nodejs dependencies&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> npm ci&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e"># Run app as node&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#75715e">#USER node&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> mkdir config&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> mkdir config/img&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> mkdir config/pdf&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">RUN&lt;/span> mkdir config/cache&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#66d9ef">CMD&lt;/span> [&lt;span style="color:#e6db74">&amp;#34;node&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;index.js&amp;#34;&lt;/span>]&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As you can see, the dockerfile I ended up with is substantial. Some of the issues I had to contend with were:&lt;/p>
&lt;ul>
&lt;li>Apt Couldn&amp;rsquo;t find my dependencies in the apt repository
&lt;ul>
&lt;li>This was solved by prepending &lt;code>apt-get install&lt;/code> commands with &lt;code>apt-get update&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Imagemagick requires ghostscript as a dependency&lt;/li>
&lt;li>puppeteer&amp;rsquo;s chromium installation couldn&amp;rsquo;t launch
&lt;ul>
&lt;li>After scouring stackoverflow I found that my docker image was missing necessary resources for chrome to run, like fonts. I ended up installing google chrome via apt to resolve chromium&amp;rsquo;s dependency issues&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Imagemagick didn&amp;rsquo;t have permission to read the filesystem
&lt;ul>
&lt;li>I had to use the &lt;code>sed&lt;/code> command to edit imagemagick&amp;rsquo;s &lt;code>policy.xml&lt;/code> to allow it to access to the filesystem so that it could convert pdfs&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Imagemagick uses the filesystem as a cache. This is a problem as if you don&amp;rsquo;t mount imagemagick&amp;rsquo;s cache directory to a docker volume, your &lt;code>docker.img&lt;/code> size will bloat as pdfs are and converted
&lt;ul>
&lt;li>Imagemagick conveniently allows you to configure it&amp;rsquo;s cache directory using the environment variable &lt;code>MAGICK_TMPDIR&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>I&amp;rsquo;m pretty happy with the result I ended up with. I learned a lot about web scraping and more complicated deployments with docker. I had a few regrets after I was done though. For one, I only ended up scraping data from the house clerk site, as at the time I made the false assumption that the house clerk served both senate and house disclosures. Secondly, I threw this project together using plain javascript, with no framework or typescript. The lack of typescript is probably what ended up hurting me the most because when I went back to add support for senate disclosures, I had to try to remember what data lived in my variables and typescript would have made my life much simpler. I&amp;rsquo;m currently in the process of rewriting this project using &lt;code>NestJS&lt;/code> which is a framework inspired by angular which makes managing the organization of your code much easier. I can separate out the concerns of components of my project by domain into modules which give me a warm fuzzy feeling inside. Some other improvements I could have made were to first check if an API exists to gather this information before bothering with web scraping, but I was in such a hurry to see it working so I failed to do so. I&amp;rsquo;m currently having issues scraping the Senate Clerk site so that might be the push I need to go that route.&lt;/p>
&lt;h2 id="tldr">TLDR:&lt;/h2>
&lt;p>I wrote a twitter bot that tracks congressional financial disclosures&lt;/p>
&lt;ul>
&lt;li>Lessons Learned
&lt;ul>
&lt;li>Before resorting to web scraping, check if an API already exists&lt;/li>
&lt;li>Typescript is your best friend when you revisit your project a few months after deployment&lt;/li>
&lt;li>When starting a project, think about organization. Would you benefit from using a framework?&lt;/li>
&lt;li>Deployment is sometimes harder than development&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>The bot is currently hosted on a Dell R710 that lives under my bed. You can see the bot at &lt;a href="https://twitter.com/congressionalfd">@CongressionalFD&lt;/a>, and you can look at the source code &lt;a href="https://github.com/ThatNerdUKnow/Financial-Disclosures">here&lt;/a>&lt;/p></content></item></channel></rss>